<!DOCTYPE html>
<html>
<head>
    <title>Unmerge Customer</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
<div class="logo-container">
    <img src="bloomreach-white.svg" alt="Bloomreach Logo" class="logo">
</div>
<div class="container">
    <h1>Unmerge Customer Events</h1>
    <div class="card-container">
        <div class="card">
            <h2><i class="fas fa-cogs"></i> Configuration</h2>
            <div>
                <label for="customer-id-key">Customer ID Key:</label>
                <input type="text" id="customer-id-key" value="email">
            </div>
            <div>
                <label for="customer-email">Customer ID Value:</label>
                <input type="text" id="customer-email" value="sample@example.com">
            </div>
            <div>
                <label for="event-mapping">Event Identification Mapping:</label>
                <textarea id="event-mapping" rows="6">
{
    "consent": ["contact_channel_value", "identification"],
    "campaign": ["message_id", "recipient", "sender"],
    "double_opt_in": ["email"],
    "newsletter_subscribe": ["email"]
}
                </textarea>
            </div>
            <button onclick="unmergeCustomer()"><i class="fas fa-file-export"></i> Export & Filter</button>
            <button class="anonymise" onclick="showAnonymiseModal()"><i class="fas fa-user-secret"></i> Anonymise
            </button>
            <button><i class="fas fa-chart-line"></i> Track all from Storage</button>
        </div>
        <div class="card storage-card">
            <h2><i class="fas fa-folder"></i> Stored Filtered Emails</h2>
            <table id="storage-table">
                <thead>
                <tr>
                    <th>Customer ID</th>
                    <th>Events</th>
                    <th>Download</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="storage-tbody">
                </tbody>
            </table>
        </div>
    </div>
    <div class="card results-card">
        <div id="loader" class="loader" style="display: none;"></div>
        <div class="results-content">
            <div class="results-header">
                <h2><i class="fas fa-list"></i> Results</h2>
                <button onclick="saveFilteredJSON()"><i class="fas fa-save"></i> Add Filtered Events to Storage</button>
            </div>
            <div id="customer-details" class="customer-details"></div>
            <h2>Customer Events <span id="original-events-count"></span></h2>
            <div id="original-tab-container" class="tab-container"></div>
            <div id="original-table-container"></div>
            <h2>Filtered Events <span id="filtered-events-count"></span></h2>
            <div id="filtered-tab-container" class="tab-container"></div>
            <div id="filtered-table-container"></div>
            <a id="download-link" style="display: none;">Download Filtered JSON</a>
        </div>
    </div>
</div>

<!-- Anonymise Confirmation Modal -->
<div id="anonymise-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAnonymiseModal()">&times;</span>
        <p id="anonymise-modal-text">Are you sure you want to anonymise this customer?</p>
        <button onclick="anonymiseCustomer()">Yes, Anonymise</button>
        <button onclick="closeAnonymiseModal()">Cancel</button>
    </div>
</div>

<script>
    class Exponea {
        constructor(apiUrl) {
            this.apiUrl = apiUrl;
        }

        async sendRequest(method, apiType, pathName, body) {
            const url = `${this.apiUrl}/${apiType}/${pathName}`;
            console.log("URL:", url);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });
                const responseBody = await response.json();

                if (!response.ok || !responseBody.success) {
                    throw new Error(`API request failed: ${JSON.stringify(responseBody)}`);
                }

                console.log("Success:", responseBody);
                return responseBody;

            } catch (error) {
                console.error("Error during API request:", error.message);
                if (error.response) {
                    console.error("Response data:", error.response.data);
                }
                throw error;
            }
        }

        exportCustomer(customerIds) {
            const body = {
                customer_ids: customerIds
            };
            console.log("Export Customer Body:", body);
            return this.sendRequest("POST", "data", "customers/export-one", body);
        }

        anonymiseCustomer(customerIds) {
            const body = {
                customer_ids: customerIds
            };
            console.log("Anonymise Customer Body:", body);
            return this.sendRequest("POST", "data", "customers/anonymize", body);
        }
    }

    async function unmergeCustomer() {
        clearResults();
        showLoader(true);

        const exponea = new Exponea('http://localhost:3000/exponea');
        const customerEmail = document.getElementById('customer-email').value;
        const customerIdKey = document.getElementById('customer-id-key').value;
        const eventMappingInput = document.getElementById('event-mapping').value;

        const exportRequestProps = {
            "customer_id": {[customerIdKey]: customerEmail}
        };

        let eventIdentificationMapping;
        try {
            eventIdentificationMapping = JSON.parse(eventMappingInput);
        } catch (error) {
            alert("Invalid JSON format in Event Identification Mapping.");
            showLoader(false);
            return;
        }

        try {
            const customer = await exponea.exportCustomer(exportRequestProps.customer_id);
            console.log('Total events:', {
                id: exportRequestProps.customer_id[customerIdKey],
                count: customer.events.length
            });
            console.log('Customer:', customer);
            displayCustomerDetails(customer.ids);

            const eventTypes = [...new Set(customer.events.map(event => event.type))];
            createTabs(eventTypes, 'original', customer.events);

            let totalOriginalEvents = 0;
            let totalFilteredEvents = 0;
            const filteredEvents = [];

            const filteredEventTypes = [];
            eventTypes.forEach(eventType => {
                const originalEvents = customer.events.filter(event => event.type === eventType);
                totalOriginalEvents += originalEvents.length;
                displayEventsInTable(eventType, originalEvents, 'original');

                const filtered = filterEventsByCustomerID(originalEvents, customerIdKey, customerEmail, eventIdentificationMapping);
                totalFilteredEvents += filtered.length;
                filteredEvents.push(...filtered);
                if (filtered.length > 0) {
                    filteredEventTypes.push(eventType);
                }
                displayEventsInTable(eventType, filtered, 'filtered');
            });

            document.getElementById('original-events-count').textContent = `(${totalOriginalEvents})`;
            document.getElementById('filtered-events-count').textContent = `(${totalFilteredEvents})`;

            if (filteredEventTypes.length > 0) {
                createTabs(filteredEventTypes, 'filtered', customer.events, true);
                document.getElementById(`original-${eventTypes[0]}`).style.display = 'block';
                document.getElementById(`tab-original-${eventTypes[0]}`).classList.add('active');
            }

            outputFilteredJSON(customerIdKey, customerEmail, filteredEvents);
        } catch (error) {
            alert(`Error: ${error.message}`);
        } finally {
            showLoader(false);
        }
    }

    async function anonymiseCustomer() {
        const exponea = new Exponea('http://localhost:3000/exponea');
        const customerEmail = document.getElementById('customer-email').value;
        const customerIdKey = document.getElementById('customer-id-key').value;
        const anonymiseRequestProps = {
            [customerIdKey]: customerEmail
        };

        try {
            await exponea.anonymiseCustomer(anonymiseRequestProps);
            alert('Customer anonymised successfully.');
            closeAnonymiseModal();
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    function showAnonymiseModal() {
        const customerEmail = document.getElementById('customer-email').value;
        document.getElementById('anonymise-modal-text').textContent = `Are you sure you want to anonymise ${customerEmail}?`;
        document.getElementById('anonymise-modal').style.display = 'block';
    }

    function closeAnonymiseModal() {
        document.getElementById('anonymise-modal').style.display = 'none';
    }

    function clearResults() {
        document.getElementById('customer-details').innerHTML = '';
        document.getElementById('original-tab-container').innerHTML = '';
        document.getElementById('original-table-container').innerHTML = '';
        document.getElementById('filtered-tab-container').innerHTML = '';
        document.getElementById('filtered-table-container').innerHTML = '';
        document.getElementById('original-events-count').textContent = '';
        document.getElementById('filtered-events-count').textContent = '';
        document.getElementById('download-link').style.display = 'none';
    }

    function showLoader(show) {
        const loader = document.getElementById('loader');
        const resultsContent = document.querySelector('.results-content');
        if (show) {
            loader.style.display = 'block';
            resultsContent.style.filter = 'blur(5px)';
        } else {
            loader.style.display = 'none';
            resultsContent.style.filter = 'none';
        }
    }

    function displayCustomerDetails(customerIds) {
        const customerDetailsDiv = document.getElementById('customer-details');
        customerDetailsDiv.innerHTML = `<strong>Customer Details:</strong> <pre>${JSON.stringify(customerIds, null, 2)}</pre>`;
    }

    function createTabs(eventTypes, prefix, events, filtered = false) {
        const tabContainer = document.getElementById(`${prefix}-tab-container`);
        tabContainer.innerHTML = '';

        eventTypes.forEach(eventType => {
            const eventCount = filtered
                ? filterEventsByCustomerID(events.filter(event => event.type === eventType), document.getElementById('customer-id-key').value, document.getElementById('customer-email').value, JSON.parse(document.getElementById('event-mapping').value)).length
                : events.filter(event => event.type === eventType).length;
            const tab = document.createElement('div');
            tab.className = `tab ${prefix}-tab`;
            tab.id = `tab-${prefix}-${eventType}`;
            tab.textContent = `${eventType} (${eventCount})`;
            tab.onclick = () => showTab(prefix, eventType);
            tabContainer.appendChild(tab);
        });
    }

    function showTab(prefix, eventType) {
        const tabs = document.querySelectorAll(`.${prefix}-tab`);
        const tables = document.querySelectorAll(`.${prefix}-table-container`);

        tabs.forEach(tab => tab.classList.remove('active'));
        tables.forEach(table => table.style.display = 'none');

        document.getElementById(`tab-${prefix}-${eventType}`).classList.add('active');
        document.getElementById(`${prefix}-${eventType}`).style.display = 'block';
    }

    function displayEventsInTable(eventType, events, prefix) {
        const container = document.createElement('div');
        container.className = `${prefix}-table-container table-container`;
        container.id = `${prefix}-${eventType}`;

        const table = document.createElement('table');

        if (events.length > 0) {
            const headers = Object.keys(flattenProperties(events[0]));
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            events.forEach(event => {
                const row = document.createElement('tr');
                const flatEvent = flattenProperties(event);
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = flatEvent[header] || '';
                    row.appendChild(td);
                });
                table.appendChild(row);
            });
        }

        container.appendChild(table);
        document.getElementById(`${prefix}-table-container`).appendChild(container);
    }

    function flattenProperties(event) {
        const flat = {};
        for (const key in event) {
            if (event.hasOwnProperty(key)) {
                if (typeof event[key] === 'object' && event[key] !== null) {
                    for (const subKey in event[key]) {
                        if (event[key].hasOwnProperty(subKey)) {
                            flat[`${key}.${subKey}`] = event[key][subKey];
                        }
                    }
                } else {
                    flat[key] = event[key];
                }
            }
        }
        return flat;
    }

    function filterEventsByCustomerID(events, customerIdKey, customerIdValue, eventIdentificationMapping) {
        return events.filter(event => isEventAssociatedWithCustomer(event, customerIdKey, customerIdValue, eventIdentificationMapping));
    }

    function isEventAssociatedWithCustomer(event, customerIdKey, customerIdValue, eventIdentificationMapping) {
        const eventType = event.type;
        const idFields = eventIdentificationMapping[eventType];
        if (!idFields) {
            return false; // Event type not found in mapping
        }
        for (const field of idFields) {
            if (event.properties && event.properties.hasOwnProperty(field)) {
                if (event.properties[field] === customerIdValue) {
                    return true;
                }
            }
        }
        return false;
    }

    function outputFilteredJSON(customerIdKey, customerIdValue, filteredEvents) {
        const filteredData = {
            ids: {
                [customerIdKey]: customerIdValue
            },
            events: filteredEvents
        };

        const timestamp = new Date().toISOString().replace(/[:.-]/g, '');
        const safeId = customerIdValue.replace(/[^a-zA-Z0-9]/g, '_');
        const filename = `${safeId}_${timestamp}.json`;

        const jsonStr = JSON.stringify(filteredData, null, 2);
        const blob = new Blob([jsonStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);

        const downloadLink = document.getElementById('download-link');
        downloadLink.href = url;
        downloadLink.download = filename;
        downloadLink.style.display = 'block';
        downloadLink.textContent = 'Download Filtered JSON';

        // Save filtered data for saving to storage
        window.filteredDataForStorage = filteredData;
        window.filteredFilename = filename;
    }

    function saveFilteredJSON() {
        if (window.filteredDataForStorage && window.filteredFilename) {
            const jsonStr = JSON.stringify(window.filteredDataForStorage, null, 2);
            localStorage.setItem(window.filteredFilename, jsonStr);
            populateStorageTable();
        } else {
            alert('No filtered data available to save.');
        }
    }

    function populateStorageTable() {
        const storageTbody = document.getElementById('storage-tbody');
        storageTbody.innerHTML = '';

        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.endsWith('.json')) {
                const idKeyValue = key.split('_')[0].replace(/_/g, '@');
                const eventCount = JSON.parse(localStorage.getItem(key)).events.length;

                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(new Blob([localStorage.getItem(key)], {type: 'application/json'}));
                downloadLink.download = key;
                downloadLink.textContent = key;

                const viewButton = document.createElement('button');
                viewButton.innerHTML = '<i class="far fa-eye"></i>';
                viewButton.onclick = () => {
                    const data = JSON.parse(localStorage.getItem(key));
                    loadStoredData(data);
                };

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '<i class="fas fa-times"></i>';
                removeButton.onclick = () => {
                    localStorage.removeItem(key);
                    populateStorageTable();
                };

                const row = document.createElement('tr');
                const idKeyCell = document.createElement('td');
                idKeyCell.textContent = idKeyValue;
                const eventCountCell = document.createElement('td');
                eventCountCell.textContent = eventCount;
                const downloadCell = document.createElement('td');
                downloadCell.appendChild(downloadLink);
                const actionCell = document.createElement('td');
                actionCell.appendChild(viewButton);
                actionCell.appendChild(removeButton);

                row.appendChild(idKeyCell);
                row.appendChild(eventCountCell);
                row.appendChild(downloadCell);
                row.appendChild(actionCell);
                storageTbody.appendChild(row);
            }
        }
    }

    async function loadStoredData(data) {
        clearResults();

        const customerIdKey = Object.keys(data.ids)[0];
        const customerIdValue = data.ids[customerIdKey];
        document.getElementById('customer-id-key').value = customerIdKey;
        document.getElementById('customer-email').value = customerIdValue;

        displayCustomerDetails(data.ids);

        const exponea = new Exponea('http://localhost:3000/exponea');
        const exportRequestProps = {
            "customer_id": {[customerIdKey]: customerIdValue}
        };

        try {
            const customer = await exponea.exportCustomer(exportRequestProps.customer_id);
            const eventTypes = [...new Set(customer.events.map(event => event.type))];
            createTabs(eventTypes, 'original', customer.events);

            let totalOriginalEvents = 0;
            let totalFilteredEvents = 0;
            const filteredEvents = data.events;

            const filteredEventTypes = [];
            eventTypes.forEach(eventType => {
                const originalEvents = customer.events.filter(event => event.type === eventType);
                totalOriginalEvents += originalEvents.length;
                displayEventsInTable(eventType, originalEvents, 'original');

                const filtered = filteredEvents.filter(event => event.type === eventType);
                totalFilteredEvents += filtered.length;
                if (filtered.length > 0) {
                    filteredEventTypes.push(eventType);
                }
                displayEventsInTable(eventType, filtered, 'filtered');
            });

            document.getElementById('original-events-count').textContent = `(${totalOriginalEvents})`;
            document.getElementById('filtered-events-count').textContent = `(${totalFilteredEvents})`;

            if (filteredEventTypes.length > 0) {
                createTabs(filteredEventTypes, 'filtered', data.events, true);
                document.getElementById(`original-${eventTypes[0]}`).style.display = 'block';
                document.getElementById(`tab-original-${eventTypes[0]}`).classList.add('active');
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
        }
    }

    // Populate the storage table on page load
    document.addEventListener('DOMContentLoaded', populateStorageTable);
</script>
</body>
</html>
